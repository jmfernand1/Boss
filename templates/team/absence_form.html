{% extends 'team/form_base.html' %}

{% block back_text %}Volver a Ausencias{% endblock %}

{% block form_content %}
<div class="row">
    <div class="col-md-6">
        <h5 class="border-bottom pb-2 mb-3">
            <i class="fas fa-user"></i> Información de la Ausencia
        </h5>
        
        <div class="mb-3">
            <label for="{{ form.employee.id_for_label }}" class="form-label">
                {{ form.employee.label }} <span class="text-danger">*</span>
            </label>
            {{ form.employee }}
            {% if form.employee.errors %}
                <div class="invalid-feedback d-block">{{ form.employee.errors|join:", " }}</div>
            {% endif %}
        </div>
        
        <div class="mb-3">
            <label for="{{ form.absence_type.id_for_label }}" class="form-label">
                {{ form.absence_type.label }} <span class="text-danger">*</span>
            </label>
            {{ form.absence_type }}
            {% if form.absence_type.errors %}
                <div class="invalid-feedback d-block">{{ form.absence_type.errors|join:", " }}</div>
            {% endif %}
        </div>
        
        <!-- Información de vacaciones disponibles -->
        <div class="vacation-info alert alert-info" style="display: none;">
            <h6><i class="fas fa-umbrella-beach"></i> Información de Vacaciones</h6>
            <div class="vacation-details">
                <!-- Se llenará dinámicamente -->
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <h5 class="border-bottom pb-2 mb-3">
            <i class="fas fa-calendar"></i> Fechas
        </h5>
        
        <div class="mb-3">
            <label for="{{ form.start_date.id_for_label }}" class="form-label">
                {{ form.start_date.label }} <span class="text-danger">*</span>
            </label>
            {{ form.start_date }}
            {% if form.start_date.errors %}
                <div class="invalid-feedback d-block">{{ form.start_date.errors|join:", " }}</div>
            {% endif %}
        </div>
        
        <div class="mb-3">
            <label for="{{ form.end_date.id_for_label }}" class="form-label">
                {{ form.end_date.label }} <span class="text-danger">*</span>
            </label>
            {{ form.end_date }}
            {% if form.end_date.errors %}
                <div class="invalid-feedback d-block">{{ form.end_date.errors|join:", " }}</div>
            {% endif %}
        </div>
    </div>
</div>

<div class="row mt-3">
    <div class="col-12">
        <h5 class="border-bottom pb-2 mb-3">
            <i class="fas fa-comment"></i> Detalles
        </h5>
        
        <div class="mb-3">
            <label for="{{ form.reason.id_for_label }}" class="form-label">
                {{ form.reason.label }}
            </label>
            {{ form.reason }}
            <div class="form-text">Motivo o justificación de la ausencia</div>
            {% if form.reason.errors %}
                <div class="invalid-feedback d-block">{{ form.reason.errors|join:", " }}</div>
            {% endif %}
        </div>
        
        <div class="mb-3">
            <label for="{{ form.notes.id_for_label }}" class="form-label">
                {{ form.notes.label }}
            </label>
            {{ form.notes }}
            <div class="form-text">Notas adicionales (opcional)</div>
            {% if form.notes.errors %}
                <div class="invalid-feedback d-block">{{ form.notes.errors|join:", " }}</div>
            {% endif %}
        </div>
    </div>
</div>

{% if form.errors %}
    {% for error in form.non_field_errors %}
        <div class="alert alert-danger">
            {{ error }}
        </div>
    {% endfor %}
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Calcular duración cuando cambien las fechas
    function calculateDuration() {
        const startDate = $('#{{ form.start_date.id_for_label }}').val();
        const endDate = $('#{{ form.end_date.id_for_label }}').val();
        
        if (startDate && endDate) {
            const start = new Date(startDate);
            const end = new Date(endDate);
            const diffTime = Math.abs(end - start);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
            
            // Mostrar duración
            let durationText = '';
            if (end >= start) {
                durationText = `<small class="text-muted">Duración: ${diffDays} día${diffDays !== 1 ? 's' : ''}</small>`;
            } else {
                durationText = `<small class="text-danger">La fecha de fin debe ser posterior a la de inicio</small>`;
            }
            
            // Buscar si ya existe el elemento de duración
            let durationElement = $('.duration-info');
            if (durationElement.length === 0) {
                $('#{{ form.end_date.id_for_label }}').after('<div class="duration-info mt-1"></div>');
                durationElement = $('.duration-info');
            }
            durationElement.html(durationText);
            
            // Verificar información de vacaciones
            checkVacationInfo();
        }
    }
    
    // Verificar y mostrar información de vacaciones
    function checkVacationInfo() {
        const employeeId = $('#{{ form.employee.id_for_label }}').val();
        const absenceTypeId = $('#{{ form.absence_type.id_for_label }}').val();
        const startDate = $('#{{ form.start_date.id_for_label }}').val();
        
        // Verificar si es tipo vacaciones (asumiendo que VAC tiene ID específico)
        if (employeeId && absenceTypeId && startDate) {
            const selectedType = $('#{{ form.absence_type.id_for_label }} option:selected').text();
            
            if (selectedType.toLowerCase().includes('vacacion')) {
                $('.vacation-info').show();
                loadVacationInfo(employeeId, startDate);
            } else {
                $('.vacation-info').hide();
            }
        } else {
            $('.vacation-info').hide();
        }
    }
    
    // Cargar información de vacaciones vía AJAX (simplificado)
    function loadVacationInfo(employeeId, date) {
        const year = new Date(date).getFullYear();
        const employeeName = $('#{{ form.employee.id_for_label }} option:selected').text();
        
        $('.vacation-details').html(`
            <p class="mb-1"><strong>Empleado:</strong> ${employeeName}</p>
            <p class="mb-1"><strong>Año:</strong> ${year}</p>
            <p class="mb-0"><small class="text-muted">Los días disponibles se validarán al guardar</small></p>
        `);
    }
    
    // Eventos
    $('#{{ form.start_date.id_for_label }}, #{{ form.end_date.id_for_label }}').on('change', calculateDuration);
    $('#{{ form.employee.id_for_label }}, #{{ form.absence_type.id_for_label }}, #{{ form.start_date.id_for_label }}').on('change', checkVacationInfo);
    
    // Calcular duración inicial si ya hay fechas
    calculateDuration();
    checkVacationInfo();
});
</script>
{% endblock %}
