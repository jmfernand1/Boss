{% extends 'initiatives/form_base.html' %}

{% block title %}
{% if action == 'create' %}
    Nuevo Sprint
{% else %}
    Editar {{ form.instance.name }}
{% endif %}
{% endblock %}

{% block form_content %}
<div class="row">
    <!-- Información Básica -->
    <div class="col-12">
        <h5 class="border-bottom pb-2 mb-4">
            <i class="fas fa-running text-primary"></i> Información del Sprint
        </h5>
    </div>
    
    <div class="col-md-8 mb-3">
        <label for="{{ form.name.id_for_label }}" class="form-label">
            {{ form.name.label }}
            {% if form.name.field.required %}
                <span class="text-danger">*</span>
            {% endif %}
        </label>
        {{ form.name }}
        <div class="form-text">Nombre descriptivo del sprint (ej: "Sprint 1 - Desarrollo Base")</div>
        {% if form.name.errors %}
            <div class="invalid-feedback d-block">
                {{ form.name.errors|join:", " }}
            </div>
        {% endif %}
    </div>
    
    <div class="col-md-4 mb-3">
        <label for="{{ form.sprint_number.id_for_label }}" class="form-label">
            {{ form.sprint_number.label }}
            {% if form.sprint_number.field.required %}
                <span class="text-danger">*</span>
            {% endif %}
        </label>
        {{ form.sprint_number }}
        <div class="form-text">Número secuencial del sprint</div>
        {% if form.sprint_number.errors %}
            <div class="invalid-feedback d-block">
                {{ form.sprint_number.errors|join:", " }}
            </div>
        {% endif %}
    </div>
    
    <div class="col-12 mb-3">
        <label for="{{ form.quarter.id_for_label }}" class="form-label">
            {{ form.quarter.label }}
            {% if form.quarter.field.required %}
                <span class="text-danger">*</span>
            {% endif %}
        </label>
        {{ form.quarter }}
        <div class="form-text">Periodo (Q) al que pertenece este sprint</div>
        {% if form.quarter.errors %}
            <div class="invalid-feedback d-block">
                {{ form.quarter.errors|join:", " }}
            </div>
        {% endif %}
    </div>
    
    <!-- Planificación Temporal -->
    <div class="col-12">
        <h5 class="border-bottom pb-2 mb-4">
            <i class="fas fa-calendar text-info"></i> Planificación Temporal
        </h5>
    </div>
    
    <div class="col-md-6 mb-3">
        <label for="{{ form.start_date.id_for_label }}" class="form-label">
            {{ form.start_date.label }} 
            {% if form.start_date.field.required %}
                <span class="text-danger">*</span>
            {% endif %}
        </label>
        {{ form.start_date }}
        {% if form.start_date.errors %}
            <div class="invalid-feedback d-block">
                {{ form.start_date.errors|join:", " }}
            </div>
        {% endif %}
    </div>
    
    <div class="col-md-6 mb-3">
        <label for="{{ form.end_date.id_for_label }}" class="form-label">
            {{ form.end_date.label }}
            {% if form.end_date.field.required %}
                <span class="text-danger">*</span>
            {% endif %}
        </label>
        {{ form.end_date }}
        {% if form.end_date.errors %}
            <div class="invalid-feedback d-block">
                {{ form.end_date.errors|join:", " }}
            </div>
        {% endif %}
    </div>
    
    <!-- Duración calculada -->
    <div class="col-12 mb-3">
        <div class="alert alert-light" id="duration-info">
            <i class="fas fa-clock"></i> <strong>Duración:</strong> <span id="duration-text">Selecciona fechas para calcular</span>
        </div>
    </div>
    
    <!-- Objetivo del Sprint -->
    <div class="col-12">
        <h5 class="border-bottom pb-2 mb-4">
            <i class="fas fa-target text-success"></i> Objetivo y Configuración
        </h5>
    </div>
    
    <div class="col-12 mb-3">
        <label for="{{ form.goal.id_for_label }}" class="form-label">
            {{ form.goal.label }}
        </label>
        {{ form.goal }}
        <div class="form-text">Describe el objetivo principal de este sprint y qué se espera lograr</div>
        {% if form.goal.errors %}
            <div class="invalid-feedback d-block">
                {{ form.goal.errors|join:", " }}
            </div>
        {% endif %}
    </div>
    
    <!-- Estado -->
    <div class="col-12 mb-3">
        <div class="form-check">
            {{ form.is_active }}
            <label class="form-check-label" for="{{ form.is_active.id_for_label }}">
                {{ form.is_active.label }}
            </label>
            <div class="form-text">Solo puede haber un sprint activo a la vez por periodo. Al activar este sprint, se desactivarán automáticamente los demás del mismo periodo.</div>
        </div>
        {% if form.is_active.errors %}
            <div class="invalid-feedback d-block">
                {{ form.is_active.errors|join:", " }}
            </div>
        {% endif %}
    </div>
    
    <!-- Presets de duración -->
    <div class="col-12">
        <div class="card bg-light">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-magic"></i> Presets de Duración</h6>
            </div>
            <div class="card-body">
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-outline-secondary" onclick="setSprintDuration(7)">
                        1 Semana
                    </button>
                    <button type="button" class="btn btn-outline-secondary" onclick="setSprintDuration(14)">
                        2 Semanas
                    </button>
                    <button type="button" class="btn btn-outline-secondary" onclick="setSprintDuration(21)">
                        3 Semanas
                    </button>
                    <button type="button" class="btn btn-outline-secondary" onclick="setSprintDuration(30)">
                        1 Mes
                    </button>
                </div>
                <small class="form-text text-muted d-block mt-2">
                    Estos botones configuran automáticamente la fecha de fin basada en la fecha de inicio
                </small>
            </div>
        </div>
    </div>
    
    <!-- Vista previa del sprint -->
    <div class="col-12 mt-3">
        <div class="alert alert-info">
            <h6><i class="fas fa-info-circle"></i> Vista Previa del Sprint</h6>
            <div id="sprint-preview">
                <p class="mb-1"><strong>Sprint:</strong> <span id="preview-name">{{ form.name.value|default:"Nuevo Sprint" }}</span></p>
                <p class="mb-1"><strong>Periodo:</strong> <span id="preview-quarter">{{ form.quarter.value|default:"Seleccionar periodo" }}</span></p>
                <p class="mb-0"><strong>Duración:</strong> <span id="preview-duration">Por definir</span></p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
{{ block.super }}
<style>
.duration-preset {
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    padding: 0.75rem;
    margin: 0.25rem;
    cursor: pointer;
    transition: all 0.2s ease;
    text-align: center;
}

.duration-preset:hover {
    border-color: #0d6efd;
    background: #f8f9fa;
}

.duration-preset.selected {
    border-color: #0d6efd;
    background: #e7f3ff;
    font-weight: 600;
}

.sprint-info-card {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-radius: 0.5rem;
    padding: 1rem;
}

.timeline-visual {
    background: #fff;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    padding: 1rem;
    margin: 1rem 0;
}

.date-range-bar {
    height: 8px;
    background: linear-gradient(90deg, #0d6efd 0%, #198754 100%);
    border-radius: 4px;
    margin: 0.5rem 0;
}

.preset-buttons {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 0.5rem;
    margin-top: 1rem;
}
</style>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const nameInput = document.getElementById('{{ form.name.id_for_label }}');
    const quarterInput = document.getElementById('{{ form.quarter.id_for_label }}');
    const startDateInput = document.getElementById('{{ form.start_date.id_for_label }}');
    const endDateInput = document.getElementById('{{ form.end_date.id_for_label }}');
    const sprintNumberInput = document.getElementById('{{ form.sprint_number.id_for_label }}');
    
    // Actualizar vista previa y duración
    function updatePreview() {
        // Actualizar nombre en vista previa
        if (nameInput.value) {
            document.getElementById('preview-name').textContent = nameInput.value;
        }
        
        // Actualizar periodo en vista previa
        if (quarterInput.value && quarterInput.selectedIndex > 0) {
            const quarterText = quarterInput.options[quarterInput.selectedIndex].text;
            document.getElementById('preview-quarter').textContent = quarterText;
        }
        
        // Calcular y mostrar duración
        if (startDateInput.value && endDateInput.value) {
            const start = new Date(startDateInput.value);
            const end = new Date(endDateInput.value);
            const diffTime = Math.abs(end - start);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            const weeks = Math.floor(diffDays / 7);
            const days = diffDays % 7;
            
            let durationText = '';
            if (weeks > 0) {
                durationText += weeks + (weeks === 1 ? ' semana' : ' semanas');
                if (days > 0) {
                    durationText += ' y ' + days + (days === 1 ? ' día' : ' días');
                }
            } else {
                durationText = diffDays + (diffDays === 1 ? ' día' : ' días');
            }
            
            durationText += ' (' + diffDays + ' días totales)';
            
            document.getElementById('duration-text').textContent = durationText;
            document.getElementById('preview-duration').textContent = durationText;
        } else {
            document.getElementById('duration-text').textContent = 'Selecciona fechas para calcular';
            document.getElementById('preview-duration').textContent = 'Por definir';
        }
    }
    
    // Auto-generar nombre del sprint
    function generateSprintName() {
        if (quarterInput.value && quarterInput.selectedIndex > 0 && sprintNumberInput.value && !nameInput.value) {
            const quarterText = quarterInput.options[quarterInput.selectedIndex].text;
            const sprintNumber = sprintNumberInput.value;
            const suggestedName = `Sprint ${sprintNumber} - ${quarterText}`;
            nameInput.value = suggestedName;
            updatePreview();
        }
    }
    
    // Event listeners
    [nameInput, quarterInput, startDateInput, endDateInput, sprintNumberInput].forEach(function(input) {
        if (input) {
            input.addEventListener('input', updatePreview);
            input.addEventListener('change', updatePreview);
        }
    });
    
    // Auto-generar nombre cuando cambian quarter o número
    [quarterInput, sprintNumberInput].forEach(function(input) {
        if (input) {
            input.addEventListener('change', generateSprintName);
        }
    });
    
    // Inicializar vista previa
    updatePreview();
    
    // Validación de fechas
    function validateDates() {
        if (startDateInput.value && endDateInput.value) {
            const start = new Date(startDateInput.value);
            const end = new Date(endDateInput.value);
            
            if (end <= start) {
                endDateInput.setCustomValidity('La fecha de fin debe ser posterior a la fecha de inicio');
            } else {
                endDateInput.setCustomValidity('');
            }
        }
    }
    
    [startDateInput, endDateInput].forEach(function(input) {
        if (input) {
            input.addEventListener('change', validateDates);
        }
    });
    
    // Advertencia sobre sprint activo
    const isActiveCheckbox = document.getElementById('{{ form.is_active.id_for_label }}');
    if (isActiveCheckbox) {
        isActiveCheckbox.addEventListener('change', function() {
            if (this.checked) {
                if (!confirm('Al activar este sprint, se desactivarán automáticamente todos los demás sprints del mismo periodo. ¿Continuar?')) {
                    this.checked = false;
                }
            }
        });
    }
    
    // Sugerir siguiente número de sprint
    if (quarterInput) {
        quarterInput.addEventListener('change', function() {
            if (this.value && !sprintNumberInput.value) {
                // En una implementación real, aquí se haría una consulta AJAX
                // para obtener el siguiente número de sprint disponible
                sprintNumberInput.value = 1;
                generateSprintName();
            }
        });
    }
});

function setSprintDuration(days) {
    const startDateInput = document.getElementById('{{ form.start_date.id_for_label }}');
    const endDateInput = document.getElementById('{{ form.end_date.id_for_label }}');
    
    if (!startDateInput.value) {
        alert('Primero selecciona una fecha de inicio');
        startDateInput.focus();
        return;
    }
    
    const startDate = new Date(startDateInput.value);
    const endDate = new Date(startDate);
    endDate.setDate(startDate.getDate() + days);
    
    // Formatear fecha para input type="date"
    const formattedEndDate = endDate.toISOString().split('T')[0];
    endDateInput.value = formattedEndDate;
    
    // Actualizar vista previa
    document.dispatchEvent(new Event('change'));
}

function suggestSprintName() {
    const quarterInput = document.getElementById('{{ form.quarter.id_for_label }}');
    const sprintNumberInput = document.getElementById('{{ form.sprint_number.id_for_label }}');
    const nameInput = document.getElementById('{{ form.name.id_for_label }}');
    
    if (quarterInput.value && sprintNumberInput.value) {
        const quarterText = quarterInput.options[quarterInput.selectedIndex].text;
        const sprintNumber = sprintNumberInput.value;
        const suggestion = `Sprint ${sprintNumber} - ${quarterText}`;
        
        if (confirm(`¿Usar el nombre sugerido: "${suggestion}"?`)) {
            nameInput.value = suggestion;
        }
    }
}
</script>
{% endblock %}
