{% extends 'base.html' %}

{% block title %}Tablero de Sprint{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-md-8">
            <h1><i class="fas fa-columns"></i> Tablero de Sprint</h1>
            {% if active_sprint %}
                <p class="lead">{{ active_sprint.name }} - {{ active_sprint.quarter }}</p>
                <div class="d-flex align-items-center">
                    <small class="text-muted me-3">
                        <i class="fas fa-calendar"></i> {{ active_sprint.start_date|date:"d/m/Y" }} - {{ active_sprint.end_date|date:"d/m/Y" }}
                    </small>
                    {% if active_sprint.goal %}
                        <small class="badge bg-primary">{{ active_sprint.goal|truncatewords:8 }}</small>
                    {% endif %}
                </div>
            {% else %}
                <p class="lead text-muted">No hay un sprint activo</p>
            {% endif %}
        </div>
        <div class="col-md-4 text-end">
            <div class="btn-group" role="group">
                <a href="{% url 'initiatives:dashboard' %}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Dashboard
                </a>
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-outline-primary dropdown-toggle" data-bs-toggle="dropdown">
                        <i class="fas fa-running"></i> Sprints
                    </button>
                    <ul class="dropdown-menu">
                        {% for sprint in sprints %}
                            <li>
                                <a class="dropdown-item {% if sprint == active_sprint %}active{% endif %}" 
                                   href="?sprint={{ sprint.id }}">
                                    {{ sprint.name }}
                                    {% if sprint.is_active %}
                                        <span class="badge bg-success ms-2">Activo</span>
                                    {% endif %}
                                </a>
                            </li>
                        {% empty %}
                            <li><span class="dropdown-item-text text-muted">No hay sprints disponibles</span></li>
                        {% endfor %}
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="{% url 'initiatives:sprint_create' %}"><i class="fas fa-plus"></i> Nuevo Sprint</a></li>
                        <li><a class="dropdown-item" href="{% url 'initiatives:sprint_list' %}"><i class="fas fa-list"></i> Lista de Sprints</a></li>
                        
                    </ul>
                </div>
            </div>
        </div>
    </div>

    {% if active_sprint %}
    <!-- Tablero Kanban -->
    <div class="kanban-board">
        <div class="row g-3">
            {% for status_name, initiatives in initiatives_by_status.items %}
            <div class="col-md-2">
                <div class="kanban-column">
                    <div class="kanban-header 
                        {% if status_name == 'Backlog' %}bg-secondary
                        {% elif status_name == 'Planeado' %}bg-primary
                        {% elif status_name == 'En Progreso' %}bg-warning
                        {% elif status_name == 'Bloqueado' %}bg-danger
                        {% elif status_name == 'Completado' %}bg-success
                        {% else %}bg-dark{% endif %}">
                        <h6 class="mb-0 text-white">
                            {{ status_name }}
                            <span class="badge bg-light text-dark ms-2">{{ initiatives.count }}</span>
                        </h6>
                    </div>
                    <div class="kanban-body" data-status="{{ status_name }}">
                        {% for initiative in initiatives %}
                        <div class="kanban-card" data-initiative-id="{{ initiative.id }}">
                            <div class="card">
                                <div class="card-body p-3">
                                    <!-- Header de la tarjeta -->
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <div class="flex-grow-1">
                                            <h6 class="card-title mb-1">
                                                {% if initiative.is_operational %}
                                                    <i class="fas fa-cogs text-warning" title="Operativo"></i>
                                                {% endif %}
                                                {{ initiative.title|truncatewords:5 }}
                                            </h6>
                                        </div>
                                        <div class="dropdown">
                                            <button class="btn btn-sm btn-link p-0" data-bs-toggle="dropdown">
                                                <i class="fas fa-ellipsis-v"></i>
                                            </button>
                                            <ul class="dropdown-menu dropdown-menu-end">
                                                <li>
                                                    <a class="dropdown-item" href="{% url 'initiatives:initiative_detail' initiative.pk %}">
                                                        <i class="fas fa-eye"></i> Ver Detalles
                                                    </a>
                                                </li>
                                                <li>
                                                    <a class="dropdown-item" href="#">
                                                        <i class="fas fa-edit"></i> Editar
                                                    </a>
                                                </li>
                                                <li><hr class="dropdown-divider"></li>
                                                <li>
                                                    <a class="dropdown-item" href="#" onclick="moveToStatus({{ initiative.id }}, 'IN_PROGRESS')">
                                                        <i class="fas fa-play"></i> Mover a En Progreso
                                                    </a>
                                                </li>
                                                <li>
                                                    <a class="dropdown-item" href="#" onclick="moveToStatus({{ initiative.id }}, 'COMPLETED')">
                                                        <i class="fas fa-check"></i> Marcar Completado
                                                    </a>
                                                </li>
                                                <li>
                                                    <a class="dropdown-item" href="#" onclick="moveToStatus({{ initiative.id }}, 'BLOCKED')">
                                                        <i class="fas fa-ban"></i> Marcar Bloqueado
                                                    </a>
                                                </li>
                                            </ul>
                                        </div>
                                    </div>
                                    
                                    <!-- Tipo y prioridad -->
                                    <div class="mb-2">
                                        <span class="badge" style="background-color: {{ initiative.initiative_type.color }}; font-size: 0.7em;">
                                            {{ initiative.initiative_type.name }}
                                        </span>
                                        {% if initiative.priority == 'CRITICAL' %}
                                            <span class="badge bg-danger ms-1" style="font-size: 0.7em;">Crítica</span>
                                        {% elif initiative.priority == 'HIGH' %}
                                            <span class="badge bg-warning ms-1" style="font-size: 0.7em;">Alta</span>
                                        {% endif %}
                                    </div>
                                    
                                    <!-- Descripción -->
                                    {% if initiative.description %}
                                        <p class="card-text small text-muted mb-2">
                                            {{ initiative.description|truncatewords:12 }}
                                        </p>
                                    {% endif %}
                                    
                                    <!-- Progreso -->
                                    <div class="mb-2">
                                        <div class="d-flex justify-content-between align-items-center mb-1">
                                            <small class="text-muted">Progreso</small>
                                            <small>{{ initiative.progress }}%</small>
                                        </div>
                                        <div class="progress" style="height: 4px;">
                                            <div class="progress-bar 
                                                {% if initiative.progress < 25 %}bg-danger
                                                {% elif initiative.progress < 50 %}bg-warning
                                                {% elif initiative.progress < 75 %}bg-info
                                                {% else %}bg-success{% endif %}" 
                                                style="width: {{ initiative.progress }}%">
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Footer de la tarjeta -->
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div class="d-flex align-items-center">
                                            <img src="https://via.placeholder.com/24x24/007bff/ffffff?text={{ initiative.owner.user.first_name.0 }}{{ initiative.owner.user.last_name.0 }}" 
                                                 alt="{{ initiative.owner.full_name }}" 
                                                 class="rounded-circle me-1" 
                                                 title="{{ initiative.owner.full_name }}">
                                            {% if initiative.collaborators.exists %}
                                                <small class="text-muted">+{{ initiative.collaborators.count }}</small>
                                            {% endif %}
                                        </div>
                                        <div class="text-end">
                                            {% if initiative.target_date %}
                                                <small class="text-muted">
                                                    {{ initiative.target_date|date:"d/m" }}
                                                    {% if initiative.target_date < today and initiative.status != 'COMPLETED' %}
                                                        <i class="fas fa-exclamation-triangle text-danger ms-1" title="Vencido"></i>
                                                    {% endif %}
                                                </small>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% empty %}
                            <div class="text-center text-muted py-3">
                                <i class="fas fa-plus-circle fa-2x mb-2 opacity-25"></i>
                                <p class="small mb-0">Arrastra iniciativas aquí</p>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Estadísticas del Sprint -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-chart-bar"></i> Estadísticas del Sprint</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% for status_name, initiatives in initiatives_by_status.items %}
                        <div class="col-md-2">
                            <div class="text-center">
                                <h4 class="
                                    {% if status_name == 'Completado' %}text-success
                                    {% elif status_name == 'En Progreso' %}text-warning
                                    {% elif status_name == 'Bloqueado' %}text-danger
                                    {% else %}text-primary{% endif %}">
                                    {{ initiatives.count }}
                                </h4>
                                <p class="mb-0 small">{{ status_name }}</p>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    
                    <!-- Progreso general -->
                    <div class="mt-4">
                        <h6>Progreso General del Sprint</h6>
                        {% with total_initiatives=initiatives_by_status.values|length completed_initiatives=initiatives_by_status.Completado.count|default:0 %}
                        {% if total_initiatives > 0 %}
                            {% widthratio completed_initiatives total_initiatives 100 as completion_percentage %}
                            <div class="progress mb-2" style="height: 20px;">
                                <div class="progress-bar bg-success" style="width: {{ completion_percentage }}%">
                                    {{ completion_percentage }}%
                                </div>
                            </div>
                            <small class="text-muted">
                                {{ completed_initiatives }} de {{ total_initiatives }} iniciativas completadas
                            </small>
                        {% else %}
                            <p class="text-muted">No hay iniciativas en este sprint</p>
                        {% endif %}
                        {% endwith %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    {% else %}
    <!-- No hay sprint activo -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body text-center py-5">
                    <i class="fas fa-running fa-3x text-muted mb-3"></i>
                    <h5>No hay un sprint activo</h5>
                    <p class="text-muted">Configure un sprint activo para usar el tablero Kanban.</p>
                    <div class="btn-group" role="group">
                        <a href="#" class="btn btn-primary">
                            <i class="fas fa-plus"></i> Crear Nuevo Sprint
                        </a>
                        {% if sprints %}
                            <button type="button" class="btn btn-outline-primary dropdown-toggle" data-bs-toggle="dropdown">
                                <i class="fas fa-list"></i> Ver Sprints Existentes
                            </button>
                            <ul class="dropdown-menu">
                                {% for sprint in sprints %}
                                    <li>
                                        <a class="dropdown-item" href="?sprint={{ sprint.id }}">
                                            {{ sprint.name }}
                                        </a>
                                    </li>
                                {% endfor %}
                            </ul>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_css %}
<style>
.kanban-board {
    min-height: 70vh;
}

.kanban-column {
    background: #f8f9fa;
    border-radius: 0.5rem;
    height: 100%;
    min-height: 500px;
}

.kanban-header {
    padding: 1rem;
    border-radius: 0.5rem 0.5rem 0 0;
    font-weight: 600;
}

.kanban-body {
    padding: 1rem;
    min-height: 450px;
    max-height: 70vh;
    overflow-y: auto;
}

.kanban-card {
    margin-bottom: 1rem;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    cursor: move;
}

.kanban-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.kanban-card .card {
    border: none;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.kanban-card.dragging {
    opacity: 0.5;
    transform: rotate(5deg);
}

.kanban-body.drag-over {
    background: rgba(13, 110, 253, 0.1);
    border: 2px dashed #0d6efd;
}

.card-title {
    font-size: 0.9rem;
    line-height: 1.2;
}

.card-text {
    font-size: 0.8rem;
    line-height: 1.3;
}

.progress {
    background-color: #e9ecef;
}

.user-avatar {
    width: 24px;
    height: 24px;
    background: #6c757d;
    border-radius: 50%;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 0.7rem;
    font-weight: 600;
}

.status-stats {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-radius: 0.5rem;
    padding: 1rem;
}

/* Responsive design */
@media (max-width: 768px) {
    .kanban-board .col-md-2 {
        margin-bottom: 1rem;
    }
    
    .kanban-column {
        min-height: 300px;
    }
    
    .kanban-body {
        min-height: 250px;
        max-height: 50vh;
    }
}

/* Animaciones */
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.kanban-card {
    animation: fadeIn 0.3s ease;
}

/* Estados especiales */
.priority-critical {
    border-left: 4px solid #dc3545 !important;
}

.priority-high {
    border-left: 4px solid #ffc107 !important;
}

.overdue {
    background: linear-gradient(45deg, transparent 40%, rgba(220, 53, 69, 0.1) 50%, transparent 60%);
}
</style>
{% endblock %}

{% block extra_js %}
<script>
function moveToStatus(initiativeId, newStatus) {
    if (confirm('¿Cambiar el estado de esta iniciativa?')) {
        // Implementar lógica AJAX para cambiar estado
        alert(`Funcionalidad de cambio de estado a ${newStatus} pendiente de implementar`);
    }
}

// Drag and Drop functionality
document.addEventListener('DOMContentLoaded', function() {
    const cards = document.querySelectorAll('.kanban-card');
    const columns = document.querySelectorAll('.kanban-body');
    
    // Hacer las tarjetas arrastrables
    cards.forEach(card => {
        card.draggable = true;
        
        card.addEventListener('dragstart', function(e) {
            this.classList.add('dragging');
            e.dataTransfer.setData('text/plain', this.dataset.initiativeId);
        });
        
        card.addEventListener('dragend', function(e) {
            this.classList.remove('dragging');
        });
    });
    
    // Configurar columnas como destinos de drop
    columns.forEach(column => {
        column.addEventListener('dragover', function(e) {
            e.preventDefault();
            this.classList.add('drag-over');
        });
        
        column.addEventListener('dragleave', function(e) {
            this.classList.remove('drag-over');
        });
        
        column.addEventListener('drop', function(e) {
            e.preventDefault();
            this.classList.remove('drag-over');
            
            const initiativeId = e.dataTransfer.getData('text/plain');
            const newStatus = this.dataset.status;
            const draggedCard = document.querySelector(`[data-initiative-id="${initiativeId}"]`);
            
            if (draggedCard && this !== draggedCard.parentNode) {
                // Mover la tarjeta visualmente
                this.appendChild(draggedCard);
                
                // Aquí se haría la llamada AJAX para actualizar el estado en el backend
                console.log(`Moviendo iniciativa ${initiativeId} a estado ${newStatus}`);
                
                // Mostrar notificación
                showNotification(`Iniciativa movida a ${newStatus}`, 'success');
            }
        });
    });
});

function showNotification(message, type = 'info') {
    // Crear notificación temporal
    const notification = document.createElement('div');
    notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    // Auto-eliminar después de 3 segundos
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 3000);
}

// Actualizar timestamps cada minuto
setInterval(function() {
    const timeElements = document.querySelectorAll('[data-timestamp]');
    timeElements.forEach(element => {
        // Actualizar timestamps relativos si es necesario
        console.log('Actualizando timestamps...');
    });
}, 60000);
</script>
{% endblock %}
